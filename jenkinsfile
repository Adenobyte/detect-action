/*
* This pipeline script was created manually based on scripts created by jenkins-build-creator.
*
*/
@Library('integration-pipeline-library@master')
import com.synopsys.integration.pipeline.SimplePipeline
properties(
    [
        disableConcurrentBuilds(), 
        parameters(
            [
                gitParameter(
                    branch: '', 
                    branchFilter: '.*', 
                    defaultValue: 'origin/main', 
                    description: 'The branch you want to build. If none are selected, origin/main will be chosen', 
                    name: 'BRANCH', 
                    quickFilterEnabled: false, 
                    selectedValue: 'NONE', 
                    sortMode: 'NONE', 
                    tagFilter: '*', 
                    type: 'PT_BRANCH_TAG'
                )
            ]
        ),
        pipelineTriggers(
            [
                cron('H H(0-6) * * *'),
                pollSCM('H/15 * * * *')
            ]
        )
    ]
)

String emailRecipients = ''
def gitUrl = 'https://github.com/synopsys-sig/detect-action.git'
String branch = (params.BRANCH != null) ? "${BRANCH}" : 'origin/master'
String archivePattern = 'dist/*.js'

node('integrations') {
    SimplePipeline pipeline = new SimplePipeline(this)
    pipeline.addCleanupStep('.')

    String gitBranch = pipeline.determineGitBranch(branch)
    pipeline.setDirectoryFromBranch(gitBranch)
    def gitStage = pipeline.addGitStage(gitUrl, gitBranch, false)
    gitStage.setChangelog(true)

    pipeline.addApiTokenStage()

    pipeline.setUrl(gitUrl)
    pipeline.setGithubCredentialsId(gitStage.getCredentialsId())
    pipeline.addEmailPipelineWrapper(emailRecipients)

    def buildStage = pipeline.addStage('Build'){
        sh 'npm ci && npm run all'
    }

    pipeline.addArchiveStage(archivePattern)

    pipeline.run()
}
