/*
* This pipeline script was created manually based on scripts created by jenkins-build-creator.
*
*/
@Library('integration-pipeline-library@master') _
import com.synopsys.integration.Constants
pipeline {
    options {
        limitBuildsToKeep()
        disableConcurrentBuilds()
    }
    parameters {
        releaseCheckbox()
        releaseCommitMessage()
        selectBranch('origin/main')
    }
    stage('Git') {
        steps {
            git branch: params.BRANCH, url: 'https://github.com/synopsys-sig/detect-action.git'
        }
    }
    stage('Release') {
        when {
            allOf {
                expression { return params.RUN_RELEASE }
                not { branch 'main' }
            }
        }
        steps {
            sh 'npm ci'
            sh 'npm version $(git rev-parse --abbrev-ref HEAD)'
            archiveArtifacts 'dist/*.js*'
        }
    }
    post {
        failure {
            echo 'Sending out Build Failure email'
            emailext(
                body: '$DEFAULT_CONTENT', 
                subject: '$DEFAULT_SUBJECT', 
                to: Constants.CENTRAL_INTEGRATIONS_TEAM_EMAIL
            )
        } 
        fixed {
            echo 'Sending out Build Fixed email'
            emailext(
                body: "${env.JOB_NAME} - Build #${env.BUILD_NUMBER} - Fixed!\nCheck console output at ${env.BUILD_URL} to view the results.", 
                subject: "${env.JOB_NAME} - Build #${env.BUILD_NUMBER} - Fixed!", 
                to: Constants.CENTRAL_INTEGRATIONS_TEAM_EMAIL
            )
        }
    }
}
